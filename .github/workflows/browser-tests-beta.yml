name: Browser Tests (Beta)

on:
  schedule:
    # Run weekly on Sunday at 3 AM UTC to catch beta browser updates
    - cron: '0 3 * * 0'
  workflow_dispatch:
    # Allow manual triggering from the Actions tab

permissions:
  contents: read # to fetch code (actions/checkout)

env:
  NODE_VERSION: 24.x

jobs:
  chrome-beta:
    runs-on: ubuntu-latest
    name: Chrome Beta
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Use Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: '**/package-lock.json'

      - name: Install Chrome Beta
        run: |
          # Chrome Beta from `@puppeteer/browsers` is a Chrome for Testing build.
          # This version lacks the sandbox setup that the APT-packaged Chrome has,
          # causing crashes on Ubuntu 23.10+ due to AppArmor restrictions.
          # Because of that, install Chrome Beta from Google's official APT repo.
          wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
          echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list
          sudo apt-get update
          sudo apt-get install -y google-chrome-beta

      - name: Install ChromeDriver Beta
        run: |
          # ChromeDriver is not available in the APT repo, so let's install
          # it using `@puppeteer/browsers`.
          CHROME_VERSION=$(google-chrome-beta --version | grep -oP '\d+\.\d+\.\d+\.\d+')
          echo "Chrome Beta version: $CHROME_VERSION"

          # Install matching ChromeDriver using @puppeteer/browsers
          # The output format is: "chromedriver@<version> <path>"
          INSTALL_OUTPUT=$(npx @puppeteer/browsers install chromedriver@$CHROME_VERSION)
          CHROMEDRIVER_PATH=$(echo "$INSTALL_OUTPUT" | grep "^chromedriver@" | cut -d' ' -f2)
          echo "ChromeDriver installed at: $CHROMEDRIVER_PATH"

          # Add ChromeDriver directory to PATH (prepend to override system chromedriver)
          CHROMEDRIVER_DIR=$(dirname "$CHROMEDRIVER_PATH")
          echo "PATH=$CHROMEDRIVER_DIR:$PATH" >> "$GITHUB_ENV"

          # Set Chrome binary
          echo "CHROME_BIN=$(which google-chrome-beta)" >> "$GITHUB_ENV"

          # Verify installations
          google-chrome-beta --version
          "$CHROMEDRIVER_PATH" --version

      - name: Install dependencies
        run: npm ci

      - name: Run Chrome Beta tests
        id: run-chrome-tests
        run: npm run test:chrome
        continue-on-error: true # Beta browsers may have bugs

  firefox-beta:
    runs-on: ubuntu-latest
    name: Firefox Beta
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Use Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: '**/package-lock.json'

      - name: Install Firefox Beta
        run: |
          wget --no-verbose "https://download.mozilla.org/?product=firefox-beta-latest-ssl&lang=en-US&os=linux64" -O - | tar -Jx -C "$HOME"

      - name: Set Firefox Beta as default
        run: |
          echo "PATH=${HOME}/firefox:$PATH" >> "$GITHUB_ENV"
          echo "FIREFOX_BIN=${HOME}/firefox/firefox" >> "$GITHUB_ENV"
          "$HOME/firefox/firefox" --version
          echo "Firefox Beta installed at: $HOME/firefox/firefox"

      - name: Install dependencies
        run: npm ci

      - name: Run Firefox Beta tests
        id: run-firefox-tests
        run: npm run test:firefox
        continue-on-error: true # Beta browsers may have bugs

  safari-tp:
    runs-on: macos-latest
    name: Safari Technology Preview
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Use Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: '**/package-lock.json'

      - name: Install Safari Technology Preview
        run: |
          # Install Safari Technology Preview via Homebrew Cask
          brew install --cask safari-technology-preview

          # Verify installation
          if [ -d "/Applications/Safari Technology Preview.app" ]; then
            echo "Safari Technology Preview installed successfully"
          else
            echo "Safari TP installation verification failed"
            exit 1
          fi

      - name: Enable Safari Technology Preview driver
        run: sudo /Applications/Safari\ Technology\ Preview.app/Contents/MacOS/safaridriver --enable

      - name: Install dependencies
        run: npm ci

      - name: Run Safari Technology Preview tests
        id: run-safari-tests
        run: npm run test:safari -- --safari-tp
        continue-on-error: true # Beta browsers may have bugs
